var SYNAPSEUI=function(){var k=$("#span-filter-type"),s=$("#txt-filter"),l=$("#listbox-plan-list"),e=$("#grid-plan-history"),t=$("#code-result-plan"),a=$("#treelist-dynamic-params"),i=$("#diagram-plan"),r=$("#diagram-result-plan"),v=$("#txt-request-number"),y=$("#btn-show-result-plan-diagram"),u=null,h=null,n=kendo.observable({selectedPlanName:"",selectedInstanceId:"",lastExecutedInstanceId:"",isExecute:!0,tabstripSelected:"",isReset:function(){return!this.get("isExecute")},planSelected:function(){return this.get("selectedPlanName")!==""},planExecuted:function(){return this.get("lastExecutedInstanceId")!==""},instanceSelected:function(){return this.get("selectedInstanceId")!==""},planDiagramIsVisible:!1,planInputIsVisible:function(){return!this.get("planDiagramIsVisible")},toggleShowPlanDiagram:function(){this.set("planDiagramIsVisible",!this.get("planDiagramIsVisible"));o(i.getKendoDiagram())},resultPlanDiagramIsVisible:!1,resultPlanCodeIsVisible:function(){return!this.get("resultPlanDiagramIsVisible")},toggleShowResultPlanDiagram:function(){var n=!this.get("resultPlanDiagramIsVisible");this.set("resultPlanDiagramIsVisible",n);n?y.text("Hide Diagram"):y.text("Show Diagram");o(r.getKendoDiagram())},reduceTextSize:function(n){n.preventDefault();t.animate({"font-size":"-=1"})},increaseTextSize:function(n){n.preventDefault();t.animate({"font-size":"+=1"})},resetTextSize:function(n){n.preventDefault();t.css("font-size","")},showNRecs:5,autoRefreshStatus:!1,autoRefreshStatusCountDown:60,autoRefreshStatusChange:function(){this.get("autoRefreshStatus")?p():w()},toggleFilterType:function(n){$(n.target).toggleClass("regex-filter in-string-filter");s.attr("placeholder",$(n.target).hasClass("regex-filter")?"RegEx Filter":"In-String Filter")}});n.bind("change",function(n){switch(n.field){case"selectedPlanName":this.set("isExecute",!0);this.set("lastExecutedInstanceId","");c();g();nt();this.get("autoRefreshStatus")&&p();break;case"selectedInstanceId":b()}});var d=function(){s.keyup(function(n){console.log("txt-filter.keyup() is called.",n);l.data("kendoListBox").dataSource.read()})},p=function(){n.set("autoRefreshStatusCountDown",60);w();h=setInterval(function(){var t=n.get("autoRefreshStatusCountDown")-1;n.set("autoRefreshStatusCountDown",t);t===0&&(n.set("autoRefreshStatusCountDown",60),n.get("selectedPlanName")!=""&&c())},1e3)},w=function(){h!==null&&clearInterval(h)},fi=function(){t.empty().closest("pre").scrollTop(0).scrollLeft(0)},c=function(){n.get("selectedPlanName")===""?e.data("kendoGrid").dataSource.data([]):e.getKendoGrid().dataSource.read()},g=function(){n.get("selectedPlanName")===""?i.data("kendoDiagram").dataSource.data([]):i.getKendoDiagram().dataSource.read()},nt=function(){n.get("selectedPlanName")===""?a.data("kendoTreeList").dataSource.data([]):a.data("kendoTreeList").dataSource.read()},b=function(){t.empty().closest("pre").scrollTop(0).scrollLeft(0);var u=n.get("selectedPlanName"),i=n.get("selectedInstanceId");i===""?r.data("kendoDiagram").dataSource.data([]):($.ajax({async:!0,method:"GET",url:f("GetPlanStatus","Home"),data:{planUniqueName:u,planInstanceId:i},dataType:"json"}).done(function(n){var i=JSON.stringify(n,null,4);t.html(i)}).fail(function(){t.html("There was a problem reading the file")}),r.getKendoDiagram().dataSource.read())},o=function(n){var t=n.viewport(),r,i;t.width>0&&t.height>0&&(r=n.boundingBox(),i=Math.min(t.width/(r.width+50),t.height/(r.height+50)),i=i<1?i<.5?.5:i:1,n.zoom(i,new kendo.dataviz.diagram.Point(t.x+t.width/2),t.y+t.height/2),n.pan(new kendo.dataviz.diagram.Point(0,0)),n.resize())},f=function(n,t){return $("base").attr("href")+t+"/"+n},tt=function(){i.kendoDiagram({autoBind:!1,editable:!1,selectable:{multiple:!1},dataSource:{transport:{read:{url:f("GetPlanForDiagram","Home"),data:SYNAPSEUI.diagramPlanData,type:"Get"}},schema:{model:{id:"Name",fields:{Status:{type:"string"},StatusColor:{type:"string"}},children:"Actions"}}},layout:{type:"Tree",subType:"Down",horizontalSeparation:30,verticalSeparation:30},shapeDefaults:{visual:SYNAPSEUI.diagramPlanVisualTemplate,editable:{drag:!1}},connectionDefaults:{stroke:{color:"#787878",width:1},editable:!1,endCap:{type:"ArrowEnd",fill:{color:"#979797"}}},dataBound:SYNAPSEUI.diagramPlanDataBound,pannable:{key:"none"}});var n=i.getKendoDiagram();n.bringIntoView(n.shapes)},it=function(){r.kendoDiagram({autoBind:!1,editable:!1,selectable:{multiple:!1},dataSource:{transport:{read:{url:f("GetResultPlanForDiagram","Home"),data:SYNAPSEUI.diagramResultPlanData,type:"Get"}},schema:{model:{id:"Name",fields:{Status:{type:"string"},StatusColor:{type:"string"}},children:"Actions"}}},layout:{type:"Tree",subType:"Down",horizontalSeparation:30,verticalSeparation:30},shapeDefaults:{visual:SYNAPSEUI.diagramResultPlanVisualTemplate,editable:{drag:!1}},connectionDefaults:{stroke:{color:"#787878",width:1},editable:!1,endCap:{type:"ArrowEnd",fill:{color:"#979797"}}},dataBound:SYNAPSEUI.diagramResultPlanDataBound,pannable:{key:"none"}});var n=r.getKendoDiagram();n.bringIntoView(n.shapes)},rt=function(){tt();it();d();u=$("#noti").data("kendoNotification");kendo.bind(document.body,n)},ut=function(){l.data("kendoListBox").dataSource.read()},ft=function(){return{filterString:s.val(),isRegexFilter:k.hasClass("regex-filter")}},et=function(t){var i=$(t.sender.wrapper).find(".k-item.k-state-selected").text();n.set("selectedPlanName",i)},ot=function(){n.set("selectedPlanName","")},st=function(t){n.set("tabstripSelected",$(t.item).find("> .k-link").text())},ht=function(){return{planUniqueName:n.get("selectedPlanName"),showNRecs:n.get("showNRecs")}},ct=function(t){var i=t.sender.wrapper.children(".k-grid-content");i.scrollLeft(0);i.scrollTop(0);e.getKendoGrid().dataSource.data().length!==0&&setTimeout(function(){e.getKendoGrid().select(t.sender.tbody.find("tr:first"))},50);n.set("selectedInstanceId","")},lt=function(t){var i=t.sender.dataItem(this.select());n.set("selectedInstanceId",i.PlanInstanceId)},at=function(n){if(n.element.is("td")){var t=n.element.closest("tr");t.hasClass("k-state-selected")||this.select(t)}},vt=function(){c()},yt=function(){b()},pt=function(){var t=n.get("selectedPlanName");return{planUniqueName:t}},wt=function(){$("select.js-dynamic-value").kendoDropDownList()},bt=function(){var i,t,r;n.get("isExecute")&&(i=n.get("selectedPlanName"),t={},$.each($("input.js-dynamic-value, .js-dynamic-value[data-role='dropdownlist']"),function(n,i){i.value=i.value.trim();var r=$(this).closest("tr").find(".js-pass-blank");i.value.length!==0?(t[i.name]=i.value,r.prop("checked",!1)):r.is(":checked")&&(t[i.name]=i.value)}),r={PlanUniqueName:i,RequestNumber:v.val().trim().length===0?null:v.val().trim(),DynamicParameters:t},$.ajax({async:!0,method:"POST",url:f("StartPlan","Home"),contentType:"application/json",data:JSON.stringify(r),dataType:"text"}).done(function(t){var i=JSON.stringify(t,null,4);t==="0"?u.error("Something is wrong. Execute plan request failed."):(n.set("lastExecutedInstanceId",t),n.set("isExecute",!1),u.info("Execute request submitted. Instance id: "+t))}).fail(function(){u.error("Something is wrong. Execute plan request failed.")}))},kt=function(){n.set("isExecute",!0)},dt=function(){$.ajax({async:!0,method:"POST",url:f("CancelPlan","Home"),data:{planUniqueName:n.get("selectedPlanName"),planInstanceId:n.get("selectedInstanceId")},dataType:"text"}).done(function(){u.info("Cancel request submitted. Click refresh to check status")}).fail(function(){u.error("There was a problem submiting the cancel request")})},gt=function(){var t=n.get("selectedPlanName");return{planUniqueName:t}},ni=function(n){var t=kendo.dataviz,i=new t.diagram.Group,r=n.dataItem,u;return i.append(new t.diagram.Rectangle({width:200,height:75,stroke:{color:r.StatusColor,width:1}})),r.IsActionGroup&&i.append(new t.diagram.Rectangle({width:7,height:75,x:0,y:0,stroke:{width:0},fill:{color:r.StatusColor}})),u=new t.diagram.Layout(new t.diagram.Rect(0,0,200,75),{alignContent:"center",alignItems:"center",justifyContent:"center",orientation:"vertical"}),i.append(u),u.append(new t.diagram.TextBlock({text:r.Name,fontSize:12,fill:"#787878"})),u.reflow(),i},ti=function(){var n=i.getKendoDiagram(),r,t;if(n.dataSource.data().length!==0){for(r=n.connections.length,t=0;t<r;t++){var u=n.connections[t].from,f=n.connections[t].to,e=u.getPosition("bottom"),s=f.getPosition("top"),h={x:e.x,y:e.y},c={x:s.x,y:s.y};n.connections[t].source(u.connectors[1]);n.connections[t].target(f.connectors[0]);n.connections[t].redraw({stroke:{width:1,color:"#979797"},points:[h,c]})}o(n)}},ii=function(){return{planUniqueName:n.get("selectedPlanName"),planInstanceId:n.get("selectedInstanceId")}},ri=function(n){var t=kendo.dataviz,u=new t.diagram.Group,i=n.dataItem,r;return u.append(new t.diagram.Rectangle({width:200,height:75,stroke:{color:i.StatusColor,width:1}})),i.IsActionGroup&&u.append(new t.diagram.Rectangle({width:7,height:75,x:0,y:0,stroke:{width:0},fill:{color:i.StatusColor}})),r=new t.diagram.Layout(new t.diagram.Rect(0,0,200,75),{alignContent:"center",alignItems:"center",justifyContent:"center",orientation:"vertical"}),u.append(r),r.append(new t.diagram.TextBlock({text:i.Name,fontSize:12,fill:"#787878"})),r.append(new t.diagram.TextBlock({text:i.StatusText,fontSize:12,fill:"#787878"})),r.reflow(),u},ui=function(){var n=r.getKendoDiagram(),i,t;if(n.dataSource.data().length!==0){for(i=n.connections.length,t=0;t<i;t++){var u=n.connections[t].from,f=n.connections[t].to,e=u.getPosition("bottom"),s=f.getPosition("top"),h={x:e.x,y:e.y},c={x:s.x,y:s.y};n.connections[t].source(u.connectors[1]);n.connections[t].target(f.connectors[0]);n.connections[t].redraw({stroke:{width:1,color:"#979797"},points:[h,c]})}o(n)}};return{init:rt,btnRefreshPlanListClick:ut,listboxPlanListData:ft,listboxPlanListChange:et,listboxPlanListDataBound:ot,tabstripSelect:st,gridPlanHistoryData:ht,gridPlanHistoryDataBound:ct,gridPlanHistoryChange:lt,gridPlanHistoryNavigate:at,btnRefreshPlanHistoryClick:vt,treelistDynamicParamsData:pt,treelistDynamicParamsDataBound:wt,btnExecutePlanClick:bt,btnResetClick:kt,btnCancelPlanClick:dt,diagramPlanData:gt,diagramPlanVisualTemplate:ni,diagramPlanDataBound:ti,diagramResultPlanData:ii,diagramResultPlanVisualTemplate:ri,diagramResultPlanDataBound:ui,btnRefreshResultPlanClick:yt}}();$.ajaxSetup({timeout:6e4,error:function(n){noti.error(n.statusText)}});$(document).ready(function(){SYNAPSEUI.init()});