var SYNAPSEUI=SYNAPSEUI||{};SYNAPSEUI.planExec=function(){var $spanFilterType=$("#span-filter-type"),$txtFilter=$("#txt-filter"),$listboxPlanList=$("#listbox-plan-list"),$gridPlanHistory=$("#grid-plan-history"),$codeResultPlan=$("#code-result-plan"),$treelistDynamicParams=$("#treelist-dynamic-params"),$diagramPlan=$("#diagram-plan"),$diagramResultPlan=$("#diagram-result-plan"),$txtRequestNumber=$("#txt-request-number"),$btnShowResultPlanDiagram=$("#btn-show-result-plan-diagram"),autoRefreshStatusId=null,planVM=kendo.observable({selectedPlanName:"",selectedInstanceId:"",lastExecutedInstanceId:"",isExecute:!0,tabstripSelected:"",isReset:function(){return!this.get("isExecute")},planSelected:function(){return this.get("selectedPlanName")!==""},planExecuted:function(){return this.get("lastExecutedInstanceId")!==""},instanceSelected:function(){return this.get("selectedInstanceId")!==""},planDiagramIsVisible:!1,planInputIsVisible:function(){return!this.get("planDiagramIsVisible")},toggleShowPlanDiagram:function(){this.set("planDiagramIsVisible",!this.get("planDiagramIsVisible"));resizeDiagram($diagramPlan.getKendoDiagram())},resultPlanDiagramIsVisible:!1,resultPlanCodeIsVisible:function(){return!this.get("resultPlanDiagramIsVisible")},toggleShowResultPlanDiagram:function(){var show=!this.get("resultPlanDiagramIsVisible");this.set("resultPlanDiagramIsVisible",show);show?$btnShowResultPlanDiagram.text("Hide Diagram"):$btnShowResultPlanDiagram.text("Show Diagram");resizeDiagram($diagramResultPlan.getKendoDiagram())},reduceTextSize:function(e){e.preventDefault();$codeResultPlan.animate({"font-size":"-=1"})},increaseTextSize:function(e){e.preventDefault();$codeResultPlan.animate({"font-size":"+=1"})},resetTextSize:function(e){e.preventDefault();$codeResultPlan.css("font-size","")},showNRecs:5,autoRefreshStatus:!1,autoRefreshStatusCountDown:60,autoRefreshStatusChange:function(){this.get("autoRefreshStatus")?startAutoRefreshStatusCountDown():stopAutoRefreshStatusCountDown()},toggleFilterType:function(e){$(e.target).toggleClass("regex-filter in-string-filter");$txtFilter.attr("placeholder",$(e.target).hasClass("regex-filter")?"RegEx Filter":"In-String Filter")}});planVM.bind("change",function(e){switch(e.field){case"selectedPlanName":this.set("isExecute",!0);this.set("lastExecutedInstanceId","");refreshPlanHistory();refreshPlanDiagram();refreshDynamicParameters();this.get("autoRefreshStatus")&&startAutoRefreshStatusCountDown();break;case"selectedInstanceId":refreshResultPlan()}});var bindUIActions=function(){$txtFilter.on("keyup",$.debounce(1e3,function(){refreshPlanList()}))},startAutoRefreshStatusCountDown=function(){planVM.set("autoRefreshStatusCountDown",60);stopAutoRefreshStatusCountDown();autoRefreshStatusId=setInterval(function(){var cnt=planVM.get("autoRefreshStatusCountDown")-1;planVM.set("autoRefreshStatusCountDown",cnt);cnt===0&&(planVM.set("autoRefreshStatusCountDown",60),planVM.get("selectedPlanName")!==""&&refreshPlanHistory())},1e3)},stopAutoRefreshStatusCountDown=function(){autoRefreshStatusId!==null&&clearInterval(autoRefreshStatusId)},clearResultPlan=function(){$codeResultPlan.empty().closest("pre").scrollTop(0).scrollLeft(0)},refreshPlanList=function(){$listboxPlanList.data("kendoListBox").dataSource.data([]);$listboxPlanList.data("kendoListBox").dataSource.read()},refreshPlanHistory=function(){$gridPlanHistory.data("kendoGrid").dataSource.data([]);$gridPlanHistory.getKendoGrid().dataSource.read()},refreshPlanDiagram=function(){$diagramPlan.data("kendoDiagram").dataSource.data([]);$diagramPlan.getKendoDiagram().dataSource.read()},refreshDynamicParameters=function(){$treelistDynamicParams.data("kendoTreeList").dataSource.data([]);$treelistDynamicParams.data("kendoTreeList").dataSource.read()},refreshResultPlan=function(){clearResultPlan();$diagramResultPlan.data("kendoDiagram").dataSource.data([]);var pn=planVM.get("selectedPlanName"),instanceId=planVM.get("selectedInstanceId");pn!==""&&instanceId!==""&&($.ajax({async:!0,method:"GET",url:getActionUrl("GetPlanStatus","PlanExecution"),data:{planUniqueName:pn,planInstanceId:instanceId},dataType:"json"}).done(function(data){var c=JSON.stringify(data,null,4);$codeResultPlan.html(c)}),$diagramResultPlan.getKendoDiagram().dataSource.read())},resizeDiagram=function(diagram){var viewportRect=diagram.viewport(),diagramRect,zoom;viewportRect.width>0&&viewportRect.height>0&&(diagramRect=diagram.boundingBox(),zoom=Math.min(viewportRect.width/(diagramRect.width+50),viewportRect.height/(diagramRect.height+50)),zoom=zoom<1?zoom<.5?.5:zoom:1,diagram.zoom(zoom,new kendo.dataviz.diagram.Point(viewportRect.x+viewportRect.width/2),viewportRect.y+viewportRect.height/2),diagram.pan(new kendo.dataviz.diagram.Point(0,0)),diagram.resize())},getActionUrl=function(action,controller){return $("base").attr("href")+controller+"/"+action},createPlanDiagram=function(){$diagramPlan.kendoDiagram({autoBind:!1,editable:!1,selectable:{multiple:!1},dataSource:{transport:{read:{url:getActionUrl("GetPlanForDiagram","PlanExecution"),data:SYNAPSEUI.planExec.diagramPlanData,type:"Get"}},schema:{model:{id:"Name",fields:{Status:{type:"string"},StatusColor:{type:"string"}},children:"Actions"}}},layout:{type:"Tree",subType:"Down",horizontalSeparation:30,verticalSeparation:30},shapeDefaults:{visual:SYNAPSEUI.planExec.diagramPlanVisualTemplate,editable:{drag:!1}},connectionDefaults:{stroke:{color:"#787878",width:1},editable:!1,endCap:{type:"ArrowEnd",fill:{color:"#979797"}}},dataBound:SYNAPSEUI.planExec.diagramPlanDataBound,pannable:{key:"none"}});var diagram=$diagramPlan.getKendoDiagram();diagram.dataSource.bind("error","dataSourceError");diagram.bringIntoView(diagram.shapes)},createResultPlanDiagram=function(){$diagramResultPlan.kendoDiagram({autoBind:!1,editable:!1,selectable:{multiple:!1},dataSource:{transport:{read:{url:getActionUrl("GetResultPlanForDiagram","PlanExecution"),data:SYNAPSEUI.planExec.diagramResultPlanData,type:"Get"}},schema:{model:{id:"Name",fields:{Status:{type:"string"},StatusColor:{type:"string"}},children:"Actions"}}},layout:{type:"Tree",subType:"Down",horizontalSeparation:30,verticalSeparation:30},shapeDefaults:{visual:SYNAPSEUI.planExec.diagramResultPlanVisualTemplate,editable:{drag:!1}},connectionDefaults:{stroke:{color:"#787878",width:1},editable:!1,endCap:{type:"ArrowEnd",fill:{color:"#979797"}}},dataBound:SYNAPSEUI.planExec.diagramResultPlanDataBound,pannable:{key:"none"}});var diagram=$diagramResultPlan.getKendoDiagram();diagram.dataSource.bind("error","dataSourceError");diagram.bringIntoView(diagram.shapes)},init=function(){createPlanDiagram();createResultPlanDiagram();bindUIActions();kendo.bind(document.body,planVM)},btnRefreshPlanListClick=function(){refreshPlanList()},listboxPlanListData=function(){return{filterString:$txtFilter.val(),isRegexFilter:$spanFilterType.hasClass("regex-filter")}},dataSourceError=function(e){if(this.data([]),e){var msg=decipherJqXhrError(e.xhr,e.status);e.errors&&$.each(e.errors,function(key,value){"errors"in value&&$.each(value.errors,function(){msg+=this+"\n"})});showNotification(msg,"error")}},listboxPlanListChange=function(e){var pn=$(e.sender.wrapper).find(".k-item.k-state-selected").text();planVM.set("selectedPlanName",pn)},listboxPlanListDataBound=function(){planVM.set("selectedPlanName","")},tabstripSelect=function(e){planVM.set("tabstripSelected",$(e.item).find("> .k-link").text())},gridPlanHistoryData=function(){return{planUniqueName:planVM.get("selectedPlanName"),showNRecs:planVM.get("showNRecs")}},gridPlanHistoryDataBound=function(e){var container=e.sender.wrapper.children(".k-grid-content");container.scrollLeft(0);container.scrollTop(0);$gridPlanHistory.getKendoGrid().dataSource.data().length!==0&&setTimeout(function(){$gridPlanHistory.getKendoGrid().select(e.sender.tbody.find("tr:first"))},50);planVM.set("selectedInstanceId","")},gridPlanHistoryChange=function(e){var selectedItem=e.sender.dataItem(this.select());planVM.set("selectedInstanceId",selectedItem.PlanInstanceId)},gridPlanHistoryNavigate=function(e){if(e.element.is("td")){var r=e.element.closest("tr");r.hasClass("k-state-selected")||this.select(r)}},btnRefreshPlanHistoryClick=function(){refreshPlanHistory()},btnRefreshResultPlanClick=function(){refreshResultPlan()},treelistDynamicParamsData=function(){var pn=planVM.get("selectedPlanName");return{planUniqueName:pn}},treelistDynamicParamsDataBound=function(){$("select.js-dynamic-value").kendoDropDownList()},btnExecutePlanClick=function(){var pn,dyn,d;planVM.get("isExecute")&&(pn=planVM.get("selectedPlanName"),dyn={},$.each($("input.js-dynamic-value, .js-dynamic-value[data-role='dropdownlist']"),function(i,obj){obj.value=obj.value.trim();var $passblank=$(this).closest("tr").find(".js-pass-blank");obj.value.length!==0?(dyn[obj.name]=obj.value,$passblank.prop("checked",!1)):$passblank.is(":checked")&&(dyn[obj.name]=obj.value)}),d={PlanUniqueName:pn,RequestNumber:$txtRequestNumber.val().trim().length===0?null:$txtRequestNumber.val().trim(),DynamicParameters:dyn},$.ajax({async:!0,method:"POST",url:getActionUrl("StartPlan","PlanExecution"),contentType:"application/json",data:JSON.stringify(d),dataType:"text"}).done(function(data){var c=JSON.stringify(data,null,4);data==="0"?showNotification("Something is wrong. Execute plan request failed.","error"):(planVM.set("lastExecutedInstanceId",data),planVM.set("isExecute",!1),showNotification("Execute request submitted. Instance id: "+data,"info"))}))},btnResetClick=function(){planVM.set("isExecute",!0)},btnCancelPlanClick=function(){$.ajax({async:!0,method:"POST",url:getActionUrl("CancelPlan","PlanExecution"),data:{planUniqueName:planVM.get("selectedPlanName"),planInstanceId:planVM.get("selectedInstanceId")},dataType:"text"}).done(function(){showNotification("Cancel request submitted. Click refresh to check status","info")}).fail(function(){showNotification("There was a problem submiting the cancel request","error")})},diagramPlanData=function(){var pn=planVM.get("selectedPlanName");return{planUniqueName:pn}},diagramPlanVisualTemplate=function(options){var dataviz=kendo.dataviz,g=new dataviz.diagram.Group,dataItem=options.dataItem,layout;return g.append(new dataviz.diagram.Rectangle({width:200,height:75,stroke:{color:dataItem.StatusColor,width:1}})),dataItem.IsActionGroup&&g.append(new dataviz.diagram.Rectangle({width:7,height:75,x:0,y:0,stroke:{width:0},fill:{color:dataItem.StatusColor}})),layout=new dataviz.diagram.Layout(new dataviz.diagram.Rect(0,0,200,75),{alignContent:"center",alignItems:"center",justifyContent:"center",orientation:"vertical"}),g.append(layout),layout.append(new dataviz.diagram.TextBlock({text:dataItem.Name,fontSize:12,fill:"#787878"})),layout.reflow(),g},diagramPlanDataBound=function(){var diagram=$diagramPlan.getKendoDiagram(),numConnections,i;if(diagram.dataSource.data().length!==0){for(numConnections=diagram.connections.length,i=0;i<numConnections;i++){var shape1=diagram.connections[i].from,shape2=diagram.connections[i].to,posShape1=shape1.getPosition("bottom"),posShape2=shape2.getPosition("top"),point1={x:posShape1.x,y:posShape1.y},point2={x:posShape2.x,y:posShape2.y};diagram.connections[i].source(shape1.connectors[1]);diagram.connections[i].target(shape2.connectors[0]);diagram.connections[i].redraw({stroke:{width:1,color:"#979797"},points:[point1,point2]})}resizeDiagram(diagram)}},diagramResultPlanData=function(){return{planUniqueName:planVM.get("selectedPlanName"),planInstanceId:planVM.get("selectedInstanceId")}},diagramResultPlanVisualTemplate=function(options){var dataviz=kendo.dataviz,g=new dataviz.diagram.Group,dataItem=options.dataItem,layout;return g.append(new dataviz.diagram.Rectangle({width:200,height:75,stroke:{color:dataItem.StatusColor,width:1}})),dataItem.IsActionGroup&&g.append(new dataviz.diagram.Rectangle({width:7,height:75,x:0,y:0,stroke:{width:0},fill:{color:dataItem.StatusColor}})),layout=new dataviz.diagram.Layout(new dataviz.diagram.Rect(0,0,200,75),{alignContent:"center",alignItems:"center",justifyContent:"center",orientation:"vertical"}),g.append(layout),layout.append(new dataviz.diagram.TextBlock({text:dataItem.Name,fontSize:12,fill:"#787878"})),layout.append(new dataviz.diagram.TextBlock({text:dataItem.StatusText,fontSize:12,fill:"#787878"})),layout.reflow(),g},diagramResultPlanDataBound=function(){var diagram=$diagramResultPlan.getKendoDiagram(),numConnections,i;if(diagram.dataSource.data().length!==0){for(numConnections=diagram.connections.length,i=0;i<numConnections;i++){var shape1=diagram.connections[i].from,shape2=diagram.connections[i].to,posShape1=shape1.getPosition("bottom"),posShape2=shape2.getPosition("top"),point1={x:posShape1.x,y:posShape1.y},point2={x:posShape2.x,y:posShape2.y};diagram.connections[i].source(shape1.connectors[1]);diagram.connections[i].target(shape2.connectors[0]);diagram.connections[i].redraw({stroke:{width:1,color:"#979797"},points:[point1,point2]})}resizeDiagram(diagram)}},showNotification=function(msg,msgType,allowHideAfter=1e4,autoHideAfter=15e3){if(msg!=null){const id="#noti";var noti=$(id).data("kendoNotification");noti&&(noti.destroy(),$(id).empty());noti=$(id).kendoNotification({stacking:"up",position:{bottom:12,left:12},button:!0,allowHideAfter:allowHideAfter,autoHideAfter:autoHideAfter,hideOnClick:!1}).data("kendoNotification");noti.show(msg,msgType)}},decipherJqXhrError=function(jqXHR,textStatus){return jqXHR.status===0?"Not connected. Please verify network connection.":jqXHR.status==404?"Requested page is not found.":jqXHR.status==500?"Internal Server Error.":textStatus==="parsererror"?"Requested JSON parse failed.":textStatus==="timeout"?"Timeout error.":textStatus==="abort"?"Ajax request aborted.":"Uncaught Error. "+jqXHR.responseText};return{init:init,btnRefreshPlanListClick:btnRefreshPlanListClick,listboxPlanListData:listboxPlanListData,listboxPlanListChange:listboxPlanListChange,listboxPlanListDataBound:listboxPlanListDataBound,tabstripSelect:tabstripSelect,gridPlanHistoryData:gridPlanHistoryData,gridPlanHistoryDataBound:gridPlanHistoryDataBound,gridPlanHistoryChange:gridPlanHistoryChange,gridPlanHistoryNavigate:gridPlanHistoryNavigate,btnRefreshPlanHistoryClick:btnRefreshPlanHistoryClick,treelistDynamicParamsData:treelistDynamicParamsData,treelistDynamicParamsDataBound:treelistDynamicParamsDataBound,btnExecutePlanClick:btnExecutePlanClick,btnResetClick:btnResetClick,btnCancelPlanClick:btnCancelPlanClick,diagramPlanData:diagramPlanData,diagramPlanVisualTemplate:diagramPlanVisualTemplate,diagramPlanDataBound:diagramPlanDataBound,diagramResultPlanData:diagramResultPlanData,diagramResultPlanVisualTemplate:diagramResultPlanVisualTemplate,diagramResultPlanDataBound:diagramResultPlanDataBound,btnRefreshResultPlanClick:btnRefreshResultPlanClick,showNotification:showNotification,decipherJqXhrError:decipherJqXhrError,dataSourceError:dataSourceError}}();$(document).ready(function(){$.ajaxSetup({timeout:6e4,error:function(xhr,textStatus,errorThrown){console.log("AJAX error. Status: "+xhr.status+". Error thrown: "+errorThrown);SYNAPSEUI.planExec.showNotification(SYNAPSEUI.planExec.decipherJqXhrError(xhr,textStatus),"error")}});SYNAPSEUI.planExec.init()});